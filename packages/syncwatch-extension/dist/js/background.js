(function(){"use strict";const y=chrome.runtime.getManifest(),f=navigator.userAgent.indexOf("Firefox")>-1,M=window.matchMedia&&window.matchMedia("only screen and (hover: none) and (pointer: coarse)").matches;let c={name:null,room:null,version:null,agent:null},t=null,s="disconnect",a=[],i=null,o=null;const l="http://server.syncwatch.space/";let d=l;function _(){chrome.storage.sync.get("connectionUrl",e=>{e.connectionUrl===void 0?chrome.storage.sync.set({connectionUrl:l}):d=e.connectionUrl})}function v(){new Promise(e=>{chrome.storage.sync.get(c,n=>e(n))}).then(e=>{chrome.runtime.sendMessage({from:"sendUser",data:e})})}function p(e){e!==void 0&&(s=e),chrome.runtime.sendMessage({from:"status",status:s})}function m(e){s==="connect"&&(e!==void 0&&(o=e),chrome.runtime.sendMessage({from:"share",data:o}))}function U(){chrome.runtime.sendMessage({from:"sendUsersList",list:a})}function w(e){chrome.runtime.sendMessage({from:"sendError",error:e})}function S(e,n){s==="connect"&&i!==null&&i.url===n.url&&t.send(e)}function L(e){const n={title:e.title,url:e.url,user:c.name};m(n),t.emit("share",n)}function E(e){return new Promise(n=>{chrome.tabs.sendMessage(e.id,{from:"background",data:"isContentScriptInjected"},r=>{(chrome.runtime.lastError||r!==!0)&&n()})})}function I(e){E(e).then(()=>{chrome.tabs.executeScript(e.id,{allFrames:!0,file:"js/content.js",runAt:"document_end"},()=>{const n=chrome.runtime.lastError;n!==void 0&&console.warn("Injecting error: ",n.message)})})}function h(e){i=e,e!==null&&I(e)}function g(){chrome.tabs.query({active:!0,lastFocusedWindow:!0},e=>{o!==null&&e.length!==0&&e[0].url===o.url&&h(e[0])})}function u(e,n){chrome.notifications.create(e,n),chrome.notifications.clear(e)}function A(){f||u("Interact with page",{type:"basic",iconUrl:"icons/icon128.png",title:chrome.i18n.getMessage("notification_interact_title"),message:chrome.i18n.getMessage("notification_interact_message"),buttons:[{title:chrome.i18n.getMessage("notification_interact_button")}]})}function C(e){const n={type:"basic",iconUrl:"icons/icon128.png",title:`${e.user} ${chrome.i18n.getMessage("notification_shared_title")}`,message:e.title};f?n.message=`${e.title} (${e.url})
${chrome.i18n.getMessage("notification_shared_firefox")}`:(n.buttons=[{title:chrome.i18n.getMessage("notification_shared_button")}],n.contextMessage=e.url),u("Share",n)}function T(){u("afk",{type:"basic",iconUrl:"icons/icon128.png",title:chrome.i18n.getMessage("notification_afk_title"),message:chrome.i18n.getMessage("notification_afk_message")})}function x(e){u("error",{type:"basic",iconUrl:"icons/icon128.png",title:"Error",message:e})}function b(e){e==="Share"&&(chrome.tabs.create({url:o.url}),chrome.notifications.clear("Share")),e==="Interact with page"&&(chrome.tabs.create({url:"https://developers.google.com/web/updates/2017/09/autoplay-policy-changes"}),chrome.notifications.clear("Interact with page"))}function F(){const e=["connect","connect_error","connect_timeout","error","disconnect","reconnect","reconnecting","reconnect_error","reconnect_failed"];for(let n=0;n<e.length;n++){const r=e[n];t.on(r,()=>{p(r)})}t.on("connect",()=>{t.emit("join",c)}),t.on("disconnect",()=>{a=[],i=null})}function k(){t=io(d,{reconnection:!0,reconnectionDelayMax:1e4,reconnectionDelay:5e3,reconnectionAttempts:5}),F(),t.on("usersList",e=>{a=e.list,U()}),t.on("message",e=>{i!==null&&chrome.tabs.sendMessage(i.id,{from:"background",data:e})}),t.on("share",e=>{(o===null||o.url!==e.url)&&C(e),m(e),g()}),t.on("afk",()=>{T(),t.disconnect()}),t.on("error",e=>{w(e),x(e)})}function P(e){chrome.storage.sync.set(e)}chrome.notifications.onButtonClicked.addListener(b),chrome.notifications.onClicked.addListener(b),chrome.tabs.onUpdated.addListener((e,n,r)=>{n.status==="complete"&&o!==null&&r.url===o.url&&h(r)}),chrome.tabs.onActivated.addListener(()=>{g()}),f&&M||chrome.windows.onFocusChanged.addListener(()=>{g()}),chrome.storage.onChanged.addListener(e=>{e.connectionUrl&&(d=e.connectionUrl.newValue,s==="connect"&&(t.disconnect(),a=[],i=null,o=null,k()))}),chrome.runtime.onMessage.addListener((e,n)=>{switch(e.from){case"content":{S(e.data,n.tab);break}case"join":{c=e.data,P(c),s==="disconnect"&&(s="connecting...",k());break}case"popupShare":{chrome.tabs.query({active:!0,lastFocusedWindow:!0},r=>{h(r[0]),L(i)});break}case"getUser":{v();break}case"getStatus":{p();break}case"getUsersList":{U();break}case"getShare":{m();break}case"disconnect":{t.disconnect();break}case"console":{console.log(e.res);break}case"errorOnEvent":{A();break}}}),c.version=y.version,c.agent=navigator.userAgent,chrome.runtime.onInstalled.addListener(()=>{chrome.storage.sync.get("connectionUrl",e=>{e.connectionUrl&&(e.connectionUrl.match("syncevent.herokuapp.com")&&chrome.storage.sync.set({connectionUrl:l}),e.connectionUrl.match("http://server.syncwatch.space")&&chrome.storage.sync.set({connectionUrl:l}))})}),chrome.runtime.setUninstallURL(`https://docs.google.com/forms/d/e/1FAIpQLSd8Z6m6lAFwLk88WK8arSgMfIcJxhVROR3r64RlCo-Lfs_0rA/viewform?entry.435513449=${c.agent}&entry.126853255=${c.version}`),_()})();
